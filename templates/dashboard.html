{% extends "base.html" %}

{% block title %}Dashboard - Goal Tracker{% endblock %}

{% block content %}
<div class="h-[calc(100vh-4rem)] bg-background text-foreground flex flex-col overflow-hidden">
    <!-- Main content - Takes exact remaining height after nav (4rem) -->
    <main class="flex-1 w-[80%] mx-auto px-6 md:px-8 py-2 flex flex-col gap-4 overflow-hidden">
        <!-- Program Progress Bar with Grid Animation - Fixed height -->
        <div class="bg-card p-8 rounded-lg shadow-lg animate-fade-in flex-shrink-0" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-foreground">Program Progress</h2>
                <div>
                    <div class="font-mono text-4xl text-primary text-right" id="currentProgressText">
                        {% if progress %}{{ progress.current_progress }}%{% else %}0%{% endif %}
                    </div>
                    <div class="text-lg text-muted-foreground text-right" id="expectedProgressText">
                        Expected: {% if progress %}{{ progress.expected_progress }}%{% else %}0%{% endif %}
                    </div>
                </div>
            </div>
            <div class="relative">
                <!-- Grid of 400 squares (8 rows × 50 columns) with bigger squares -->
                <div class="grid grid-flow-col grid-rows-8 gap-1" id="progressGrid">
                    <!-- Squares will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Weekly Progress and Calendar Grid - Takes remaining height -->
        <div class="grid grid-cols-2 gap-6 flex-1 min-h-0 mb-8" id="mainGrid">
            <!-- Weekly Progress Bars - Takes 1/2 of width with scrolling when needed -->
            <div class="col-span-1 flex flex-col min-h-0" id="weeklySection">
                <div class="bg-card rounded-lg shadow-lg animate-fade-in flex flex-col h-full" style="animation-delay: 0.4s;">
                    <div class="p-4 flex-shrink-0">
                        <h2 class="text-lg font-semibold text-foreground">Weekly Breakdown</h2>
                    </div>
                    <div class="flex-1 overflow-y-auto px-4 pb-4">
                        <div class="space-y-2" id="weeklyBars">
                            <!-- Weekly bars will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Calendar - Takes 1/2 of width, no scrolling -->
            <div class="col-span-1 flex flex-col min-h-0" id="calendarSection">
                <div class="bg-card p-4 rounded-lg shadow-lg animate-fade-in flex flex-col h-full" style="animation-delay: 0.4s;">
                    <div class="flex items-center justify-between mb-2 flex-shrink-0">
                        <h2 class="text-lg font-semibold text-foreground">Daily Activity</h2>
                        <div class="flex items-center gap-2" id="calendarNavigation" style="display: none;">
                            <button id="prevMonth" class="p-1.5 rounded hover:bg-accent transition-colors">
                                <svg class="h-3.5 w-3.5 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <span id="currentMonthYear" class="text-xs text-muted-foreground min-w-[100px] text-center"></span>
                            <button id="nextMonth" class="p-1.5 rounded hover:bg-accent transition-colors">
                                <svg class="h-3.5 w-3.5 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col justify-center">
                        <div id="progressCalendar" class="space-y-1.5">
                            <!-- Calendar will be populated by JavaScript -->
                        </div>
                    </div>
                    <!-- Legend -->
                    <div class="flex items-center justify-center flex-wrap gap-x-3 gap-y-1 p-1.5 text-xs text-muted-foreground pt-2 border-t border-border mt-2 flex-shrink-0">
                        <div class="flex items-center gap-1.5">
                            <svg class="h-3 w-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="text-xs">Done</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <svg class="h-3 w-3 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                            <span class="text-xs">Partial</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <svg class="h-3 w-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span class="text-xs">Missed</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Loading indicator -->
<div id="loadingIndicator" class="fixed inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <p class="mt-4 text-lg text-foreground">Loading dashboard...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced dashboard with beautiful animations
let dashboardData = null;
let currentCalendarView = 0; // For month navigation
let totalMonths = 0;
let programMonths = [];

// English month names
const englishMonths = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
];

// English day names - starting with Monday
const englishDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    loadDashboardData();
});

function initializeDashboard() {
    // Create the progress grid (400 squares: 8 rows × 50 columns)
    createProgressGrid();
    
    // Setup calendar navigation
    document.getElementById('prevMonth').addEventListener('click', () => {
        if (currentCalendarView > 0) {
            currentCalendarView--;
            updateProgressCalendar(dashboardData.daily_status);
        }
    });
    
    document.getElementById('nextMonth').addEventListener('click', () => {
        if (currentCalendarView < totalMonths - 2) {
            currentCalendarView++;
            updateProgressCalendar(dashboardData.daily_status);
        }
    });
}

function formatDateInEnglish(date) {
    const day = date.getDate();
    const month = englishMonths[date.getMonth()];
    const year = date.getFullYear();
    return `${month} ${day}, ${year}`;
}

function createProgressGrid() {
    const grid = document.getElementById('progressGrid');
    grid.innerHTML = '';
    
    const rows = 8;
    const cols = 50;
    const totalSquares = rows * cols;
    
    // Create squares column by column for vertical fill effect
    for (let c = 0; c < cols; c++) {
        for (let r = 0; r < rows; r++) {
            const square = document.createElement('div');
            square.className = 'aspect-square rounded-sm transition-all duration-500 bg-secondary opacity-0';
            square.dataset.index = c * rows + r;
            
            // Staggered animation delay
            const delay = (c * rows + r) * 2; // 2ms delay per square
            square.style.animationDelay = `${delay}ms`;
            square.style.animation = `fadeIn 0.5s ${delay}ms ease-out forwards`;
            
            grid.appendChild(square);
        }
    }
}

async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard');
        dashboardData = await response.json();
        
        // Hide loading indicator with smooth transition
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.transition = 'opacity 0.5s ease-out';
        loadingIndicator.style.opacity = '0';
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
        }, 500);
        
        // Update all components with staggered animations
        setTimeout(() => updateProgressGrid(dashboardData.global_progress, dashboardData.expected_progress), 100);
        setTimeout(() => updateWeeklyProgress(dashboardData.weekly_progress), 200);
        setTimeout(() => updateProgressCalendar(dashboardData.daily_status), 300);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showErrorState();
    }
}

function updateProgressGrid(currentProgress, expectedProgress) {
    const progressText = document.getElementById('currentProgressText');
    const expectedText = document.getElementById('expectedProgressText');
    
    // Animate numbers
    animateNumber(progressText, 0, currentProgress, 1500);
    animateNumber(expectedText, 0, expectedProgress, 1500, 'Expected: ');
    
    const squares = document.querySelectorAll('#progressGrid > div');
    const totalSquares = squares.length;
    const filledSquares = Math.floor((currentProgress / 100) * totalSquares);
    const expectedSquares = Math.floor((expectedProgress / 100) * totalSquares);
    const isAhead = currentProgress > expectedProgress;
    const isBehind = currentProgress < expectedProgress;

    // Decide a single square to animate (pulse)
    let pulseIndex;
    if (isAhead) {
        pulseIndex = Math.max(0, Math.min(totalSquares - 1, filledSquares - 1));
    } else if (isBehind) {
        pulseIndex = Math.max(0, Math.min(totalSquares - 1, expectedSquares - 1));
    } else {
        // On schedule (or both zero) — animate the boundary of progress/expected
        pulseIndex = Math.max(0, Math.min(totalSquares - 1, filledSquares - 1));
    }
    
    squares.forEach((square, index) => {
        setTimeout(() => {
            // Clear any previous pulse animation
            square.style.animation = '';

            let squareClass = 'bg-secondary';
            
            if (index < filledSquares) {
                if (isAhead && index >= expectedSquares) {
                    squareClass = 'bg-green-500'; // Ahead of schedule
                } else {
                    squareClass = 'bg-primary'; // On schedule (within expected)
                }
            } else if (index < expectedSquares) {
                squareClass = 'bg-orange-500'; // Behind schedule
            }
            
            square.className = `aspect-square rounded-sm transition-all duration-500 ${squareClass} opacity-100`;

            // Apply pulse only to the chosen single square
            if (index === pulseIndex) {
                square.style.animation = 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite';
            }
        }, index * 3); // Staggered update
    });
}

function updateWeeklyProgress(weeklyData) {
    const container = document.getElementById('weeklyBars');
    container.innerHTML = '';
    
    // Keep original order - Week 1 first, then Week 2, etc.
    weeklyData.forEach((week, index) => {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'animate-fade-in opacity-0';
        weekDiv.style.animationDelay = `${0.5 + index * 0.1}s`;
        weekDiv.style.animation = `fadeIn 0.5s ${0.5 + index * 0.1}s ease-out forwards`;
        
        weekDiv.innerHTML = `
            <div class="flex justify-between items-end mb-2">
                <span class="text-base font-medium text-muted-foreground">${week.week}</span>
                <span class="text-xl font-mono text-primary">${Math.round(week.progress)}%</span>
            </div>
            <div class="relative h-4 w-full rounded-full bg-secondary overflow-hidden">
                <div class="absolute top-0 left-0 h-full rounded-full bg-primary transition-all duration-1000 ease-out"
                     style="width: 0%;" data-target="${week.progress}"></div>
            </div>
        `;
        
        container.appendChild(weekDiv);
        
        // Animate progress bar fill
        setTimeout(() => {
            const progressBar = weekDiv.querySelector('[data-target]');
            const target = progressBar.dataset.target;
            progressBar.style.width = `${target}%`;
        }, (0.7 + index * 0.1) * 1000);
    });
}

function updateProgressCalendar(dailyStatus) {
    const calendar = document.getElementById('progressCalendar');
    const simulatedTodayStr = '{{ simulated_today }}';
    // Parse as local date to avoid timezone off-by-one
    const [ty, tm, td] = simulatedTodayStr.split('-').map(Number);
    const today = new Date(ty, tm - 1, td);
    
    // Use actual program dates from dashboardData
    let programStartDate, programEndDate;
    
    if (dashboardData.program_start && dashboardData.program_end) {
        // Parse dates ensuring we use the local timezone to avoid off-by-one day issues
        programStartDate = new Date(dashboardData.program_start + 'T00:00:00');
        programEndDate = new Date(dashboardData.program_end + 'T23:59:59');
    } else {
        // Fallback to 4-week period if no program dates
        programStartDate = new Date(today);
        programStartDate.setDate(today.getDate() - 27); // 4 weeks ago
        programEndDate = new Date(today);
    }
    
    // Get all months in program range
    programMonths = getMonthsInRange(programStartDate, programEndDate);
    totalMonths = programMonths.length;
    
    // Setup navigation based on number of months
    const navigation = document.getElementById('calendarNavigation');
    const monthYearDisplay = document.getElementById('currentMonthYear');
    
    if (totalMonths <= 1) {
        navigation.style.display = 'none';
        displayMonths(programMonths, dailyStatus, programStartDate, programEndDate, today);
    } else if (totalMonths <= 2) {
        navigation.style.display = 'none';
        displayMonths(programMonths, dailyStatus, programStartDate, programEndDate, today);
    } else {
        navigation.style.display = 'flex';
        const monthsToShow = programMonths.slice(currentCalendarView, currentCalendarView + 2);
        displayMonths(monthsToShow, dailyStatus, programStartDate, programEndDate, today);
        
        // Update navigation display
        if (monthsToShow.length === 2) {
            monthYearDisplay.textContent = `${monthsToShow[0].name} - ${monthsToShow[1].name} ${monthsToShow[1].year}`;
        } else {
            monthYearDisplay.textContent = `${monthsToShow[0].name} ${monthsToShow[0].year}`;
        }
        
        // Update button states
        document.getElementById('prevMonth').disabled = currentCalendarView === 0;
        document.getElementById('nextMonth').disabled = currentCalendarV
iew >= totalMonths - 2;
    }
}

function toLocalYMD(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function displayMonths(monthsToShow, dailyStatus, programStartDate, programEndDate, today) {
    const calendar = document.getElementById('progressCalendar');
    let calendarHTML = '';
    
    if (monthsToShow.length > 1) {
        calendarHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
    }
    
    monthsToShow.forEach((monthData, monthIndex) => {
        calendarHTML += `<div class="month-container">`;
        
        calendarHTML += `
            <div class="text-center mb-2">
                <h3 class="font-medium text-foreground text-base">${monthData.name} ${monthData.year}</h3>
            </div>
        `;
        
        calendarHTML += '<div class="grid grid-cols-7 gap-1 mb-2">';
        englishDays.forEach(day => {
            calendarHTML += `<div class="text-center text-sm font-medium text-muted-foreground p-1 flex items-center justify-center">${day}</div>`;
        });
        calendarHTML += '</div>';
        
        calendarHTML += '<div class="grid grid-cols-7 gap-1">';
        
        const firstDay = new Date(monthData.year, monthData.month, 1);
        const startDayOfWeek = (firstDay.getDay() + 6) % 7;
        for (let i = 0; i < startDayOfWeek; i++) {
            calendarHTML += '<div class="h-8 w-8"></div>';
        }
        
        const daysInMonth = new Date(monthData.year, monthData.month + 1, 0).getDate();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(monthData.year, monthData.month, day);
            const dateStr = toLocalYMD(date);
            let status = dailyStatus[dateStr] || '';
            const isToday = date.toDateString() === today.toDateString();
            const isFuture = date > today;
            
            const programStartStr = toLocalYMD(programStartDate);
            const programEndStr = toLocalYMD(programEndDate);
            const isInProgramPeriod = dateStr >= programStartStr && dateStr <= programEndStr;
            
            let dayContent = day;
            let statusClass = '';
            let todayClass = isToday ? 'ring-1 ring-primary/80' : '';
            
            if (!isInProgramPeriod) {
                dayContent = day;
                statusClass = 'text-muted-foreground/30';
            } else if (isFuture) {
                dayContent = day;
                statusClass = 'text-foreground/90 font-medium';
            } else {
                if (!status) {
                    status = '❌'; // Mark past days with no data as missed
                }

                if (status === '✅') {
                    dayContent = `<svg class="h-3 w-3 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    statusClass = 'bg-green-50 dark:bg-green-900/20';
                } else if (status === '⚠️') {
                    dayContent = `<svg class="h-3 w-3 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>`;
                    statusClass = 'bg-yellow-50 dark:bg-yellow-900/20';
                } else if (status === '❌') {
                    dayContent = `<svg class="h-3 w-3 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                    statusClass = 'bg-red-50 dark:bg-red-900/20';
                } else {
                    dayContent = day;
                    statusClass = 'text-foreground';
                }
            }
            
            calendarHTML += `
                <div class="h-8 w-8 flex items-center justify-center text-sm rounded-sm transition-colors hover:bg-accent ${statusClass} ${todayClass}">
                    ${dayContent}
                </div>
            `;
        }
        
        calendarHTML += '</div></div>';
    });
    
    if (monthsToShow.length > 1) {
        calendarHTML += '</div>';
    }
    
    calendar.innerHTML = calendarHTML;
}

function getMonthsInRange(startDate, endDate) {
    const months = [];
    const current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const end = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    
    while (current <= end) {
        months.push({
            month: current.getMonth(),
            year: current.getFullYear(),
            name: englishMonths[current.getMonth()]
        });
        current.setMonth(current.getMonth() + 1);
    }
    
    return months;
}

function animateNumber(element, start, end, duration, prefix = '') {
    const startTime = performance.now();
    
    function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(start + (end - start) * easeOutCubic);
        
        element.textContent = `${prefix}${current}%`;
        
        if (progress < 1) {
            requestAnimationFrame(updateNumber);
        }
    }
    
    requestAnimationFrame(updateNumber);
}

function showErrorState() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    loadingIndicator.innerHTML = `
        <div class="text-center">
            <svg class="h-12 w-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-foreground">Error loading dashboard</p>
            <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90">
                Retry
            </button>
        </div>
    `;
}

// Custom CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
        opacity: 0;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
`;
document.head.appendChild(style);

// Auto-refresh dashboard every 5 minutes
setInterval(loadDashboardData, 5 * 60 * 1000);
</script>
{% endblock %} 